# 装置情報管理システム

MySQL + PHPで作成された装置情報管理システムです。CSVファイルをアップロードして、装置情報をデータベースに登録できます。

## 機能概要

- CSVファイルのアップロード機能
- 装置情報の基本テーブル（device_info）への自動登録
- サービス名と装置種別に基づく動的テーブルの自動作成
- 主キー: `[サービス名]_[装置種別名]_[装置名]_[ユーザ名]`
- 7列目以降のカラムは動的テーブルに格納

## ファイル構成

```
1031_Fusion/
├── index.php              # CSVアップロードフォーム
├── upload.php             # CSVアップロード処理
├── config.php             # アプリケーション設定
├── sample.csv             # サンプルCSVファイル
├── README.md              # このファイル
├── classes/               # クラスファイル
│   ├── Database.php       # データベース接続管理
│   ├── CsvProcessor.php   # CSV処理
│   └── DeviceManager.php  # 装置情報管理
├── database/              # データベース関連
│   └── schema.sql         # テーブル作成DDL
└── uploads/               # アップロードファイル保存先
```

## セットアップ手順

### 1. データベース準備

```sql
-- データベース作成
CREATE DATABASE device_management CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE device_management;

-- テーブル作成（schema.sqlを実行）
SOURCE database/schema.sql;
```

### 2. PHP設定

`config.php`のデータベース接続情報を環境に合わせて変更してください：

```php
define('DB_HOST', 'localhost');
define('DB_NAME', 'device_management');
define('DB_USER', 'root');
define('DB_PASS', '');
```

### 3. ディレクトリ権限

アップロード用ディレクトリに書き込み権限を設定：

```bash
chmod 755 uploads/
```

### 4. Webサーバー起動

PHPビルトインサーバーで起動する場合：

```bash
php -S localhost:8000
```

ブラウザで `http://localhost:8000` にアクセス

## CSVファイル形式

### 必須カラム（1-6列目）

| 列番号 | カラム名 | 必須 | 説明 |
|--------|----------|------|------|
| 1      | サービス名 | ○    | サービス識別名 |
| 2      | 装置種別   | ○    | 装置の種類 |
| 3      | 装置名称   | ○    | 装置の名前 |
| 4      | 装置IP     | -    | 装置のIPアドレス |
| 5      | ユーザー名 | ○    | ログインユーザー |
| 6      | パスワード | -    | ログインパスワード |

### 拡張カラム（7列目以降）

7列目以降のカラムは動的テーブルに格納されます。

### サンプルデータ

```csv
サービス名,装置種別,装置名称,装置IP,ユーザー名,パスワード,関連装置名称,関連装置IP,ポート番号
サービスA,装置種別A,souchimei,198.1.1.1,admin,admin123,kanrensouchi,198.1.1.11,1
サービスA,装置種別A,souchimei2,198.1.1.2,admin,admin123,kanrensouchi2,198.1.1.12,1
```

## データベース構造

### device_info テーブル（装置基本情報）

主キー形式で装置の基本情報を管理します。

### 動的テーブル

`[サービス名]_[装置種別名]` の形式でテーブルが自動作成され、7列目以降のデータが格納されます。

例: `サービスA_装置種別A` テーブル

## セキュリティ機能

- CSRFトークン による攻撃防止
- ファイル形式とサイズの検証
- SQLインジェクション対策（プリペアドステートメント）
- XSS対策（HTMLエスケープ）
- ファイル名サニタイズ

## 制限事項

- アップロードファイルサイズ: 最大10MB
- 対応ファイル形式: CSV（UTF-8推奨）
- 主キーの重複は上書きされます

## エラーハンドリング

- CSVファイル形式エラー
- データベース接続エラー
- ファイルアップロードエラー
- データ検証エラー

すべてのエラーはユーザーフレンドリーなメッセージで表示されます。

## 開発情報

- PHP 7.4以上推奨
- MySQL 5.7以上推奨
- フレームワーク: 使用せず（Pure PHP）
- 文字エンコーディング: UTF-8
- タイムゾーン: Asia/Tokyo

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。